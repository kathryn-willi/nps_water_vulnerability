source("setup.R")

# ecoregion shapefiles
ecoregions <- read_sf("data/Saxe_etal/Ecoregions/Ecoregions.shp")

# convert CRS of ecoregions
eco_proj <- st_transform(ecoregions, crs = "+proj=lcc +lat_0=42.5 +lon_0=-100 +lat_1=25 +lat_2=60 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs") %>% 
  st_make_valid()

# set ecoregion to analyze (code kept breaking across all, not sure where the bottleneck was)
region <- eco_proj$names[3]


# WBM data only goes back to 1980
historic_years <- 1980:2018
wb_var <- c("runoff", 
            #"rain", 
            "AET", 
            "accumswe")

map_dat <- tidyr::crossing(historic_years, wb_var)


# download and calc weighted mean for each monthly raster
remaining_eco_means <- purrr::map_df(1:nrow(map_dat), function(x) {

  call <- paste0(
    "/vsicurl/",
    "http://www.yellowstone.solutions/thredds/fileServer/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/V_1_5_",
    map_dat$historic_years[x],
    "_gridmet_historical_",
    map_dat$wb_var[x],
    "_monthly.nc4"
  )
  
  r <- terra::rast(call)
  
  names(r) <- paste(map_dat$wb_var[x],
                    paste0(map_dat$historic_years[x], "-", sub(".*_", "", names(r))),
                    sep = "_")
  
  ## saved CRS and extent from raw downloaded file, that info does not attach to files pulled directly from URL
  crs(r) <- "+proj=lcc +lat_0=42.5 +lon_0=-100 +lat_1=25 +lat_2=60 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"
  
  ext(r) <- c(-2060750, 2639250, -1915500, 1384500)
  
  # crop and calculate weighted mean
  r_eco <- #purrr::map_df(
    #region,
    terra::crop(r, eco_proj[eco_proj$names == region, ], snap = "out") %>%
      terra::subst(-32767, NA) %>%
      terra::zonal(
        vect(eco_proj[eco_proj$names == region, ]),
        fun = mean,
        weights = TRUE,
        na.rm = TRUE
      ) %>%
      pivot_longer(cols = everything()) %>%
      mutate(
        value = value / 10,
        unit = "mm",
        ecoregion = region,
        #ecoregion = x,
        model = "NPS_WBM",
      ) %>%
      separate(name, into = c("component", "date"), sep = "_") %>%
      separate(date, into = c("year", "month"), sep = "-") %>%
      mutate(month = sprintf("%02d", as.numeric(month))) %>%
      unite("date", year:month, sep = "-") %>%
      mutate(
        date = as.Date(paste0(date, "-01")),
        # rename components to match saxe names
        component = case_when(
          #component == "rain" ~ "P", oops, this is wrong
          component == "accumswe" ~ "SWE",
          component == "runoff" ~ "R",
          .default = component
        )
      )
  
  
  return(r_eco)
  

}, .progress = list(
  type = "iterator", 
  format = "{cli::pb_name} {cli::pb_bar} {cli::pb_percent} | \\
              ETA: {cli::pb_eta} - {cli::pb_elapsed_clock}",
  total = nrow(map_dat)))


write_csv(remaining_eco_means, paste0("data/Saxe_etal/", region, "_eco_means.csv"))