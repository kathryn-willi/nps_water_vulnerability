---
title: "Retrieve and Process Climate Data"
author: "Caitlin Mothes and Katie Willi"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE)
                      #cache = TRUE)

source("setup.R")
```

# Workflow to retrieve and process MACA climate data

**Codebase modified from <https://github.com/nationalparkservice/CCRP_automated_climate_futures>, led by Amber Runyon.**

Create directory structure (for now just a 'climate_test/' subfolder in 'data/'

```{r}
if (!dir.exists("data/climate_test/")) {
  dir.create("data/climate_test/")
}
```

## Workflow for single or multiple points (e.g., water supply locations)

Create points object *(eventually make this a function where sf points object is input*)

### `climateR` Method

**NOTE: `getMACA()`** works differently when given a single vs. multipoint/polygon object. With a single point it will return a time series dataframe instead of a single cell SpatRaster. If given multiple points and/or polygon it will use the extent of that object and return a SpatRaster for each cell within the extent.

```{r}
# BRCA current water supply location
lat <- 37.63281
long <- -112.2124
  
site <- data.frame(site_name = "BRCA_water_supply", lat = lat, long = long) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  # transform to CRS of MACA data
  st_transform(crs = 4269) %>% 
  st_buffer(10)
```

Set up parameters of desired climate data products

```{r}
# cutting the time range down to test faster
vars <-  c("tasmax", 
           "tasmin", 
           "pr", 
           "rhsmax", 
           "rhsmin")

# Note from Amber's code: This script does not include CCSM or NorESM because they do not have Rh and thus break the script. They are both typically central tendency models.
## cut down model ## for testing
gcms <- c("bcc-csm1-1",
         "bcc-csm1-1-m",
         "BNU-ESM",
         "CanESM2",
         "CNRM-CM5",
         # "CSIRO-Mk3-6-0",
         # "GFDL-ESM2G",
         # "GFDL-ESM2M",
         # "HadGEM2-CC365",
         # "HadGEM2-ES365",
         # "inmcm4",
         # "IPSL-CM5A-LR",
         # "IPSL-CM5A-MR",
         # "IPSL-CM5B-LR",
         "MIROC5",
         "MIROC-ESM",
         "MIROC-ESM-CHEM",  
         "MRI-CGCM3")

# either 'day' or 'month'
time_res <- "month"

# dates in YYYY-MM-DD format
start_date <- "2025-01-01"
end_date <- "2075-12-31"

```

Retrieve future MACA data

Test with small subset:

```{r}

start.time <-Sys.time()

test_MACA <-  getMACA(site, 
                      timeRes = time_res,
                      model = gcms[1],
                      varname = vars[1], 
                      scenario  = "rcp45", 
                      startDate = "2025-01-01", 
                      endDate = "2025-12-31")

end.time <- Sys.time()

end.time-start.time
```

*This will return a timeseries dataframe with a column for each combination of variable, gcm, scenario*

```{r}
start.time <-Sys.time()

# create an empty list for all combinations of gcm/variable output dataframes
future_all <- vector(mode = "list", length = length(vars)*length(gcms))

# KW: This took 2 hours for BRCA Well 1 AOI at daily up to 2099
# KW: Takes 45 minutes at monthly up to 2099
for (i in 1:length(vars)){ 
  for (j in 1:length(gcms)){ 
    print(paste("downloading", gcms[j], vars[i], sep = " "))
    # if(i<3 & j %in% c(5,20)) next
    # cat(i)
    future1 <-  getMACA(site, 
                      timeRes = time_res,
                      model = gcms[j],
                      varname = vars[i], 
                      scenario  = "rcp45", 
                      startDate = start_date, 
                      endDate = end_date)
    
    future2 <-  getMACA(site, 
                      timeRes = time_res,
                      model = gcms[j], 
                      varname = vars[i], 
                      scenario  = "rcp85",
                      startDate = start_date, 
                      endDate = end_date)
    
    if (j == 1) {
      future <- dplyr::left_join(future1, future2, by = "date")
    } else{
      try(future <- dplyr::left_join(future, future1, by = 'date') %>%
            dplyr::left_join(., future2, by = 'date'))
    }
  }
  
  future_long <- future %>%  
    tidyr::pivot_longer(-date)
  FL <- future_long %>% 
    dplyr::mutate(GCM = gsub("^[^_]*_([^_]+)_.*$", "\\1", future_long$name),
           RCP = sub('.*_', '', future_long$name)) |> 
    dplyr::rename(!!vars[i]:=value) %>% dplyr::select(-c(name))
  if(i==1) { future_all = FL } else {
    future_all = dplyr::left_join(future_all, FL, by=c("date", "GCM", "RCP"))
    # rm(future_long, FL,future1, future2, future)
  }
}

end.time <- Sys.time()

end.time-start.time
```

### [Earthlab Climate Futures Toolbox](https://github.com/earthlab/cft) method

Install from Github:

```{r}
# library(devtools)
# install_github("earthlab/cft")

library(cft)
```

Set up parallel processing:

```{r}
n_cores <- availableCores() - 1
plan(multisession, workers = n_cores)
```

Import available inputs/variables before download:

*This works on Mac, does not work on Centroid Desktop....*

```{r}
inputs <- cft::available_data()
```
