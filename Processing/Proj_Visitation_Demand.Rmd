---
title: "Proj_Visitation"
author: "KEC"
date: "2024-04-04"
output: html_document
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: 79
---

This is a subset of code from the CCVA_Processing script that can be used to
test new methods for predicting visitation and water demands at a national
park. Currently, it is hardcoded to inport Bryce Canyon data, but we can expand 
it to test other parks. Currently, we just haven't explored water use data for 
other parks in detail.

# Setup Script

```{r setup}

# read in data
source('Setup.R')
load('data/Visitation_Demand_Projections/BRCA_dat.Rdata')

library(ggpubr)
library(scales)

```

The goal of this effort is to develop a model to estimate national park water
use at individual parks. Ideally, we would have a model that performs well at
both annual and monthly timesteps that can be projected into the future up to
at least 2080. Because visitation is a major driver of water use at national
parks, we'll start by developing a model to project future visitation. We'll 
then use the visitation projections as inputs to models for water use. Note, 
water use and water demand are synonymous herein.  Also, currently 


## Visitation Model

Temperature has been identified as a strong predictor of visitation trends at
national parks (Fisichelli et al., 2015). Fisichelli et al. (2015) found that
visitation increased with temperature up to a threshold of 25 degrees C at
which point visitation decreased with increasing temperature. They demonstrated
this relationship by plotting monthly visitor proportions vs temperature. Here,
we do the same to compare with relationships identified by Fisichelli et al. 
We use the monthly mean of the maximum daily temperature of each month as the 
input for this test. 

The figure below shows that monthly visitation does not necessarily decrease
above 25 degrees Celsius. It does appear to level out above some temperature 
though and temperature and visitation clearly have a strong relationship.

Reference: Fisichelli NA, Schuurman GW, Monahan WB, Ziesler PS (2015) Protected 
Area Tourism in a Changing Climate: Will Visitation at US National Parks Warm Up
or Overheat? PLoS ONE 10(6): 
e0128226.https://doi.org/10.1371/journal.pone.0128226


### Monthly Proportion
```{r monthly_proportion, echo = FALSE, warning = FALSE, fig.width =4.5, fig.height = 3.5}

monthly_proportion <- centroid_monthly %>%
  mutate(y = year(ym)) %>%
  dplyr::filter(y < 2024) %>% # only look at historic data
  group_by(y) %>%
  mutate(vis_sum = sum(TotalVisitors, na.rm = TRUE), # total annual visitors
         monthly_vis_prop = TotalVisitors/vis_sum,   # monthly proportion of visitors
         dem_sum = sum(use_acre_feet, na.rm = TRUE), # total monthly use (af)
         monthly_dem_prop = use_acre_feet/dem_sum,   # total use proportion
         tmax_c = (tmax_f - 32)*5/9)                 # Convert T(f) to T(C)

ggplot(monthly_proportion) + geom_boxplot(aes(x = floor(tmax_c), 
                                                   y = monthly_vis_prop, 
                                                   group = floor(tmax_c))) + 
  labs(x = "Monthly Temperature (C)",
       y = "Monthly visitation (proportion)",
       title = park_boundary$UNIT_NAME) + 
  theme_bw( )


```



Next, we'll develop a simple model to predict visitation at the park using
temperature along with other inputs. Ideally, the input variables can also
be projected into the future.
We start with a multiple linear regression model. To generally identify 
model predictor variables, we'll do a quick regression between visitation and
all of the park variables. 

### Visitor regression
```{r Visitor_regression, echo = FALSE, warning = FALSE, width = "50%"}

# identify regression variables
visitor_regress <- purrr::map(
 # Elements to iterate over
  centroid_monthly %>% 
    dplyr::filter(year(ym) < 2024) %>%
    dplyr::select(-c(ym, gcm, cf, unit_climate_zone,TotalVisitors)),
  ~lm(TotalVisitors ~ .x, data = centroid_monthly %>%
        dplyr::filter(year(ym) < 2024))) %>%
  purrr::map(broom::glance) %>%
  dplyr::bind_rows(.id = "variable") %>%
  dplyr::select(variable, r.squared) %>%
  arrange(.,desc(r.squared))

visitor_regress %>%
 regulartable() %>% 
  autofit() 

```

Now, we select predictor variables and develop a multiple linear regression model.

### MLR Model

```{r visitation_MLR}

## Add and transform some variables

# Function to create a population curve from the year. The "2000" can be 
# modified to change where the population curve peaks. May want to explore more
pop_curve <- function(year, k = 0.1, L = 20) {
  ymean <- mean(year, na.rm = TRUE)
  pop <- (L / (1 + exp(-k * (year - 2000)))) + 1
}

centroid_monthly <- centroid_monthly %>%
                   mutate(TotalVisitorsLog = log(TotalVisitors),
                          y = year(ym), 
                          m = month(ym),
                          pop = pop_curve(y)) 

#plot(centroid_monthly$ym, centroid_monthly$pop)

# Develop MLR model with select variables using predictor years (1979-2000)

predict_data <- centroid_monthly %>%
  dplyr::filter(year(ym) <= 2000)

test_data <- centroid_monthly %>%
  dplyr::filter(year(ym) > 2000,
                year(ym) < 2024)

visitor_mlr = lm(formula = TotalVisitorsLog ~ 
                    tmax_f +
                    days_gt_77F +
                    days_lt_32F +
                    #days_w_swe +
                    pet_in +
                    pop,
                   data = test_data)

print(summary(visitor_mlr))


# Check model fit on test period (years 2001:2023)
test_set <- test_data %>%
  dplyr::mutate(vis_test = exp(predict(visitor_mlr, newdata = test_data))) %>%
  dplyr::select(ym, vis_test, TotalVisitors)

R_squared <- cor(test_set$TotalVisitors, test_set$vis_test) ^ 2
print(R_squared)



# Use model to project
centroid_monthly <- 
  mutate(centroid_monthly,
            TotalVisitors_mlr_fit = exp(predict(visitor_mlr, centroid_monthly)),
            TotalVisitors_mlr_lwr = exp(predict(visitor_mlr, centroid_monthly, 
                                            interval = "confidence")[,2]),
            TotalVisitors_mlr_upr = exp(predict(visitor_mlr, centroid_monthly, 
                                            interval = "confidence")[,3]),
         TotalVisitors_all = case_when(year(ym) < 2024 ~ TotalVisitors,
                                       year(ym) >= 2024 ~ TotalVisitors_mlr_fit),
         TotalVisitorsLog = log(TotalVisitors_all))


# Sum and add to annual dataset
centroid_annual <- centroid_monthly %>%
  dplyr::select(-c(ym,gcm,unit_climate_zone)) %>%
  group_by(y,cf) %>%
  dplyr::summarize(TotalVisitors_mlr_fit = sum(TotalVisitors_mlr_fit, na.rm = FALSE),
            TotalVisitors_mlr_lwr = sum(TotalVisitors_mlr_lwr, na.rm = FALSE),
            TotalVisitors_mlr_upr = sum(TotalVisitors_mlr_upr, na.rm = FALSE),
            .groups = "keep") %>%
  left_join(., centroid_annual, by = c("y","cf")) %>%
  mutate(TotalVisitors_all = case_when(y < 2024 ~ TotalVisitors,
                                       y >= 2024 ~ TotalVisitors_mlr_fit),
         TotalVisitors_log = log(TotalVisitors_all))


# Plot monthly visitors
ggplot(centroid_monthly %>% filter(year(ym) < 2070)) + 
  geom_line(aes(x = ym, 
                y = TotalVisitors_mlr_fit, 
                color = cf), 
            linewidth = 1) +
  geom_ribbon(aes(x = ym, 
                  ymin = TotalVisitors_mlr_lwr, 
                  ymax = TotalVisitors_mlr_upr),
              alpha = 0.3,
              fill = "hotpink") +
  geom_line(aes(x = ym, 
                y = TotalVisitors,color = "historical_actual"), 
            linewidth= 1) + 
  scale_color_manual("",
                     values = c("hotpink","black","red","cornflowerblue"), 
                     labels = c("MLR Model","Historical","Hot Dry", "Warm Wet" )) + 
  labs(x = "", y = "Total Monthly Visitors", title = park) + 
  theme_bw() #+ coord_trans(y = "log10") 


```

## Water Demand Model

Now develop models to predict future water demand. Start by visualizing how
per-person water use has changed through time.  

```{r demand_per_visitor, fig.width = 4, fig.height = 4, warning = FALSE, echo = FALSE}


# Start by looking at general trends in use and per person demand

a <- ggplot(centroid_monthly %>% filter(year(ym) < 2024),
            aes(x = ym, y = demand_pp_gal)) + 
  geom_point(color = "dodgerblue") +
  geom_smooth(method = "loess", formula = 'y ~ x', color = "dodgerblue4",fill = "dodgerblue4") + 
  labs(y = "Monthly", x = "", 
       title = "      Water Use (gallons per person)") +
  theme_bw()

b <- ggplot(centroid_annual %>% filter(y < 2024), 
            aes(x = y, y = demand_pp_gal)) + 
  geom_point(color = "dodgerblue") + 
  geom_smooth(method = "loess", formula = 'y ~ x', color = "dodgerblue4",fill = "dodgerblue4") + 
  labs(y = "Annual", x = "") +
  theme_bw()

ggarrange(a,b, nrow = 2)


```


Next, develop a model to predict future park water demand. Again, use multiple
linear regression for a simple approach that can be easily fit to data. Start,
again, by identifying regression variables.

```{r use_regress, fig.width = 5}

# identify regression variables
use_regress <- purrr::map(
 # Elements to iterate over
  centroid_monthly %>% 
    dplyr::filter(y < 2024) %>%
    dplyr::select(-c(ym, gcm, cf, unit_climate_zone,use_acre_feet, WRID_1258)),
  ~lm(use_acre_feet ~ .x, data = centroid_monthly %>%
        dplyr::filter(y < 2024))) %>%
  purrr::map(broom::glance) %>%
  dplyr::bind_rows(.id = "variable") %>%
  dplyr::select(variable, r.squared) %>%
  arrange(.,desc(r.squared))

use_regress %>%
 regulartable() %>% 
  autofit() 

```


### Monthly MLR
```{r demand_regress}


# Monthly model

demand_mlr_model = lm(formula = use_acre_feet ~ 
                    tmax_f +
                    days_lt_32F +
                   TotalVisitorsLog +
                     pet_in +
                     deficit_in,
                 data = centroid_monthly %>%
                              filter(year(ym) < 2023) %>%
                              mutate(use_acre_feet = 
                                ifelse(use_acre_feet == 0, NA, use_acre_feet)))

print(summary(demand_mlr_model))

centroid_monthly <- 
  mutate(centroid_monthly,
            MLR_demand_fit = predict(demand_mlr_model, centroid_monthly),
            MLR_demand_lwr = predict(demand_mlr_model, centroid_monthly, 
                                     interval = "confidence")[,2],
            MLR_demand_upr = predict(demand_mlr_model, centroid_monthly, 
                                     interval = "confidence")[,3],
         demand_all = case_when(year(ym) < 2024 ~ use_acre_feet,
                                year(ym) > 2024 ~ MLR_demand_fit))


# How does it do for annual predictions
demand_annual <- centroid_monthly %>%
  dplyr::select(c('y','use_acre_feet','MLR_demand_fit','cf')) %>%
  group_by(y,cf) %>%
  summarize_all(list(sum))

r_squared <- cor(na.omit(demand_annual) %>% pull(use_acre_feet), 
                 na.omit(demand_annual) %>% pull(MLR_demand_fit))^2

print(r_squared)

```

### Annual MLR
Annual predictions are not great. So, make a new model for annual

Start with an annual regression to identify variables. Note, for BRCA,
the relationships are MUCH weaker and there are not clear predictor variables.
This indicates that we were mainly predicting seasonality with the last model,
not necessarily year-to-year variability.

```{r annual_use_regress}

# identify regression variables
use_regress_annual <- purrr::map(
 # Elements to iterate over
  centroid_annual %>% 
    ungroup() %>%
    dplyr::filter(y < 2024) %>%
    dplyr::select(-c(gcm, cf, unit_climate_zone, use_acre_feet),
                  -contains("well")),
  ~lm(use_acre_feet ~ .x, data = centroid_annual %>%
        dplyr::filter(y < 2024))) %>%
  purrr::map(broom::glance) %>%
  dplyr::bind_rows(.id = "variable") %>%
  dplyr::select(variable, r.squared) %>%
  arrange(.,desc(r.squared))

use_regress_annual %>%
 regulartable() %>% 
  autofit() 

```

```{r annual_use_MLR}

predict_use <- centroid_annual %>%
  dplyr::filter(y < 2023) %>%
  mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA, use_acre_feet))


# multiple linear regression
demand_mlr_model_annual = lm(formula = use_acre_feet ~ 
                    days_gt_77F +
                    days_gt_95roff + 
                    snow_in +
                    aet_in +
                    TotalVisitors_all,
                 data = predict_use)

summary(demand_mlr_modelA)

centroid_annual <- centroid_annual %>%
  mutate(MLR_demandA_fit = predict(demand_mlr_modelA, newdata = centroid_annual),
         MLR_demandA_lwr = predict(demand_mlr_modelA, newdata = centroid_annual, interval = "confidence")[,2],
         MLR_demandA_upr = predict(demand_mlr_modelA, newdata = centroid_annual, interval = "confidence")[,3],
         demand_all = case_when(y < 2024 ~ use_acre_feet,
                                y > 2024 ~ MLR_demandA_fit))


# Plot both models for yearly values

# Doesn't do great for annual water use -- so develop separate annual model
a <- ggplot(demand_annual %>% 
         filter(y < 2025) %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA, use_acre_feet)) %>%
         drop_na(use_acre_feet) %>%
         pivot_longer(cols = -c(y,cf), names_to = 'vars', values_to = 'vals'),
         aes(x = y, y = vals, color = vars)) + 
  geom_line(size = 1) + 
  scale_color_manual("", values = c("hotpink","black"),
                         labels = c("MLR Model","Actual")) + 
  labs(x = "", y = "Annual Water Use (af)", title = "Monthly Model") +
  theme_bw()

b <- ggplot(centroid_annual  %>% 
         filter(y < 2025) %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA, use_acre_feet)) %>%
         drop_na(use_acre_feet)) + 
  geom_line(aes(x = y, y = use_acre_feet,
             color = "Actual Use"), size = 1) +
geom_line(aes(x = y, 
              y = MLR_demandA_fit,
             color = "MLR Model"), size = 1) +
  scale_color_manual("", values = c("black","hotpink")) +
  labs(x = "", y = "Annual Water Use", title = "Annual Model") + theme_bw() 

ggarrange(a,b,nrow = 2)

```



```{r plot_use_projections}
# Plot projections
ggplot(centroid_annual %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA,
                                       use_acre_feet))) +
  geom_line(aes(x = y, y = MLR_demandA_fit, color = cf)) +
  geom_ribbon(aes(x = y, ymin =  MLR_demandA_lwr, ymax =  MLR_demandA_upr, 
              color = cf, fill = cf), alpha = 0.2, linewidth = 0) + 
  geom_line(aes(x = y, 
                y = use_acre_feet),
                color = "black") + 
  scale_color_manual("Modeled", values = c("gray80","red","dodgerblue4")) +
  scale_fill_manual("Modeled", values = c("gray80","red","dodgerblue4")) +
  labs(x = "", y = "Annual Water Demand (af)") + 
  xlim(1980,2080) + theme_bw()


```