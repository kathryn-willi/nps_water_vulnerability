---
output: pdf_document
---

```{r include=FALSE}
knitr::opts_chunk$set(fig.height = 10, fig.width = 8, echo = FALSE, message = FALSE, warning = FALSE)
```

::: {.center data-latex=""}
# NPS Water Balance Model Comparison Report
:::

# Background

*Describe Saxe et al. paper and the goal of this report*

# Methods

*Briefly describe methods to match Saxe at al results*

# Findings

```{r setup, include=FALSE}
source("setup.R")

################################## INTERNAL NOTE ##################################
# All DATA is in the data/Saxe_etal folder. CODE used to generate NPS WBM matching data is in the saxe_comparison_job.R script

# READ IN DATASETS

## NPS WBM generated datasets
wbm_eco_means <- purrr::map_df(list.files("data/Saxe_etal", pattern = "eco_mean", full.names = TRUE), read_csv)

## Saxe et al. dataset
saxe_data <- read_csv("data/Saxe_etal/Ecoregion Aggregates.csv")


# JOIN DATASETS

annual_combined <- saxe_data %>% 
  #filter data to match wbm
  filter(ecoregion %in% wbm_eco_means$ecoregion,
         date %in% wbm_eco_means$date) %>% 
  bind_rows(wbm_eco_means) %>% 
  # summarize annual data for comparison
  mutate(year = year(date)) %>% 
  pivot_wider(names_from = component, values_from = value) %>% 
  group_by(model, ecoregion, year) %>% 
  dplyr::summarize(across(AET:R, \(x) sum(x, na.rm = TRUE), .names = "{col}_annual"),
                   SWE_annual = mean(SWE, na.rm = TRUE)) %>% 
  mutate_all(function(x) ifelse(is.nan(x), NA, x)) %>% 
  # drop NAs across all vars
  #drop_na(AET_annual, R_annual, P_annual, SWE_annual) %>% 
  # add color column for plots
  mutate(color = case_when(model == "NPS_WBM"~ "Mod1", 
                           model %in% c("NLDAS2-Noah", "NLDAS2-VIC", "Livneh-VIC") ~ "Mod2",
                           .default = "Mod3"))


monthly_combined <- saxe_data %>% 
  #filter data to match wbm
  filter(ecoregion %in% wbm_eco_means$ecoregion,
         date %in% wbm_eco_means$date) %>% 
  bind_rows(wbm_eco_means) %>% 
  # add color column for plots
  mutate(color = case_when(model == "NPS_WBM"~ "Mod1", 
                           model %in% c("NLDAS2-Noah", "NLDAS2-VIC", "Livneh-VIC") ~ "Mod2",
                           .default = "Mod3"))


```

```{r figure-functions}
# annual averages boxplot
boxplot <- function(data, variable, variable_name) {
  data %>%
    filter({{variable}} != 0) %>%
    drop_na({{variable}}) %>% 
    ggplot() +
    geom_boxplot(aes(
      x = {{variable}},
      y = reorder(model, {{variable}}, fun = median),
      fill = color
    )) +
    scale_fill_manual(
      values = c("red", "royalblue1", "white"),
      labels = c("NPS WBM", "Models of Interest", "Other Models")
    ) +
    facet_wrap( ~ ecoregion, scales = "free_x", ncol = 3) +
    labs(
      y = "",
      title = variable_name,
      x = paste0("Annual ", variable_name, " (mm)")
    ) +
    theme_minimal() +
    theme(
      legend.title = element_blank(),
      legend.position = "bottom",
      axis.text.y = element_text(size = 8),
      title = element_text(size = 14),
      text = element_text(family = "serif")
    )
}


# time series function
timeseries <- function(data, variable, variables_name) {
  data %>%
    filter(component == variable) %>%
    ggplot() +
    geom_line(aes(
      x = date,
      y = value,
      color = factor(color, levels = c("Mod3", "Mod2", "Mod1"))
    )) +
    scale_color_manual(values = c("gray", "blue", "red"),
                       labels = c("Other Models", "Models of Interest", "NPS WBM")) +
    facet_wrap(~ecoregion, scales = "free_y", ncol = 1) +
    theme_minimal() +
    theme(legend.title = element_blank()) +
    labs(title = "Monthly Runoff", y = "Total Runoff (mm)")
}

```


## Annual Averages


```{r}
# Runoff
boxplot(annual_combined, R_annual, "Runoff")
```


```{r}
# AET
boxplot(annual_combined, AET_annual, "AET")
```



```{r}
# AET
boxplot(annual_combined, SWE_annual, "SWE")
```



<br>



## Monthly Time-Series


```{r}
# Runoff
timeseries(monthly_combined, "R", "Runoff")

```

